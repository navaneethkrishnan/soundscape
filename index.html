<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Soundscape: Record & Play</title>
    <style>
        body { margin: 0; background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Main Radar Area */
        .radar-container {
            position: relative;
            margin-top: 20px;
            width: 95vw; height: 95vw;
            max-width: 600px; max-height: 600px;
            border-radius: 50%;
            border: 3px solid #333;
            background: #000;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,255,0,0.1);
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* Controls */
        .controls {
            margin: 15px; padding: 10px;
            background: #111; border-radius: 12px;
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            width: 90%; max-width: 600px; border: 1px solid #222;
        }
        
        button {
            padding: 10px 20px; font-size: 14px; border: none; border-radius: 6px; 
            cursor: pointer; color: white; font-weight: bold; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }

        .btn-start { background: #27ae60; }
        .btn-pause { background: #f39c12; }
        .btn-resume { background: #2980b9; }
        .btn-stop { background: #c0392b; }
        .btn-upload { background: #8e44ad; }

        /* Status & Info */
        #status { font-family: monospace; color: #0f0; margin-bottom: 5px; font-size: 13px; }
        
        /* Player Scan Line */
        #scanLine {
            position: absolute; top: 50%; left: 50%; width: 50%; height: 2px;
            background: #fff; transform-origin: 0 0; display: none; pointer-events: none;
            box-shadow: 0 0 8px white; z-index: 10;
        }

        /* Gallery Section */
        #gallery {
            width: 95%; max-width: 600px; margin-bottom: 50px; margin-top: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .gallery-item {
            background: #151515; border: 1px solid #333; padding: 10px; border-radius: 8px;
            display: flex; gap: 10px; align-items: center; animation: slideDown 0.4s ease;
        }
        .gallery-item img {
            width: 100px; height: 100px; object-fit: cover; border-radius: 5px; border: 1px solid #444; cursor: pointer;
        }
        .gallery-info { flex: 1; font-size: 12px; color: #aaa; }
        .gallery-actions a {
            display: inline-block; background: #333; color: white; text-decoration: none;
            padding: 5px 10px; border-radius: 4px; margin-top: 5px; font-size: 11px;
        }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="controls">
        <button class="btn-start" id="startBtn">üé§ Start Recording</button>
        <button class="btn-pause" id="pauseBtn" style="display:none;">‚è∏ Pause</button>
        <button class="btn-resume" id="resumeBtn" style="display:none;">‚ñ∂ Resume</button>
        
        <div style="border-left: 1px solid #444; margin: 0 5px;"></div>
        <button class="btn-upload" onclick="document.getElementById('fileInput').click()">üìÇ Upload & Play</button>
        <button class="btn-stop" id="stopBtn" style="display:none;">‚èπ Stop Playing</button>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <div id="status">Ready.</div>

    <div class="radar-container">
        <canvas id="radar" width="1000" height="1000"></canvas>
        <div id="scanLine"></div>
    </div>

    <h3 style="color:#444; font-size:12px; text-transform:uppercase; margin-top:30px;">Gallery (Auto-saved)</h3>
    <div id="gallery"></div>

    <script>
        // --- CONFIG ---
        const SCAN_DURATION_MS = 15000; // 15 Seconds per full rotation
        const SCAN_SPEED = (Math.PI * 2) / (SCAN_DURATION_MS / 16.6); // Angle per frame (approx 60fps)

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('radar');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const status = document.getElementById('status');
        const scanLine = document.getElementById('scanLine');
        const gallery = document.getElementById('gallery');
        
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');

        // --- STATE ---
        let audioCtx, analyser, dataArray, source, stream;
        let isScanning = false;
        let isPaused = false;
        let isPlaying = false;
        let angle = 0;
        let animationId;
        let loadedImageData = null;
        let oscs = [];

        // Initialize Black Canvas
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ==========================================
        // 1. RECORDING LOGIC
        // ==========================================

        startBtn.onclick = async () => {
            stopPlayback(); // Stop player if running
            try {
                if (!stream) {
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 4096;
                analyser.smoothingTimeConstant = 0.5; // Smooth out flickering
                source.connect(analyser);
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // Reset UI
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                status.textContent = "Recording... (Auto-saves every 15s)";
                
                // Reset Angle for fresh start
                angle = 0;
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                isScanning = true;
                isPaused = false;
                loopScan();

            } catch (err) {
                alert("Mic Error: " + err.message);
            }
        };

        pauseBtn.onclick = () => { isPaused = true; updatePauseUI(); };
        resumeBtn.onclick = () => { isPaused = false; updatePauseUI(); };

        function updatePauseUI() {
            pauseBtn.style.display = isPaused ? 'none' : 'inline-block';
            resumeBtn.style.display = isPaused ? 'inline-block' : 'none';
            status.textContent = isPaused ? "Paused." : "Recording...";
        }

        function loopScan() {
            if (!isScanning) return;
            animationId = requestAnimationFrame(loopScan);
            if (isPaused) return;

            analyser.getByteFrequencyData(dataArray);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const maxRadius = cx;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angle);

            // LOGARITHMIC MAPPING (Violet Center -> Red Edge)
            // Skip extremely low freq rumble (0-5) and high freq silence
            const startBin = 5;
            const endBin = dataArray.length * 0.75;
            const totalBins = endBin - startBin;

            // Draw slightly wider to fill gaps
            const barWidth = 4;

            for (let r = 0; r < maxRadius; r += 2) {
                const percent = r / maxRadius;
                
                // Log Formula: Maps low freq to center, high to edge
                const logIndex = startBin + (totalBins * (Math.pow(100, percent) - 1) / 99);
                const index = Math.floor(logIndex);
                const value = dataArray[index] || 0;

                if (value > 8) { // Noise Gate
                    const hue = 270 - (percent * 270); // Violet(270) -> Red(0)
                    const lightness = 5 + (value / 255) * 60; // Brighter if louder
                    
                    ctx.fillStyle = `hsl(${hue}, 100%, ${lightness}%)`;
                    ctx.fillRect(r, -barWidth/2, 4, barWidth);
                }
            }
            
            // Draw Scanner Head (White tip)
            ctx.fillStyle = '#fff';
            ctx.fillRect(maxRadius - 10, -1, 10, 2);
            
            ctx.restore();

            // Increment Angle
            angle += SCAN_SPEED;

            // CHECK FULL ROTATION (Every 15s approx)
            if (angle >= Math.PI * 2) {
                // 1. Process and Save current image to Gallery
                processAndAddToGallery();
                
                // 2. Reset for next loop
                angle = 0;
                // Clear canvas for new cycle (Wipe clean)
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        // ==========================================
        // 2. AUTO-SAVE & GALLERY LOGIC
        // ==========================================

        function processAndAddToGallery() {
            // Create Watermarked Canvas
            const tempCanvas = document.createElement('canvas');
            const footerH = 150;
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height + footerH;
            const tCtx = tempCanvas.getContext('2d');

            // Background
            tCtx.fillStyle = '#000';
            tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tCtx.drawImage(canvas, 0, 0);

            // Watermark Text
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB');
            const timeStr = now.toLocaleTimeString('en-US');
            
            tCtx.textAlign = 'center';
            tCtx.fillStyle = '#fff';
            tCtx.font = 'bold 40px monospace';
            tCtx.fillText(`${dateStr} | ${timeStr}`, tempCanvas.width/2, canvas.height + 60);
            
            tCtx.fillStyle = '#888';
            tCtx.font = '24px sans-serif';
            tCtx.fillText(window.location.href, tempCanvas.width/2, canvas.height + 110);

            // Generate Image URL
            const finalURL = tempCanvas.toDataURL('image/jpeg', 0.8);
            
            // Add to UI
            addToGalleryUI(finalURL, timeStr);
        }

        function addToGalleryUI(url, time) {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.innerHTML = `
                <img src="${url}" onclick="loadAndPlay('${url}')" title="Click to Play">
                <div class="gallery-info">
                    <strong>Recorded at ${time}</strong><br>
                    Duration: 15s<br>
                    <span style="color:#2ecc71">‚ñ∂ Click image to Play</span>
                </div>
                <div class="gallery-actions">
                    <a href="${url}" download="Soundscape_${Date.now()}.jpg">üíæ Save HD</a>
                </div>
            `;
            // Add to top
            gallery.prepend(div);
        }

        // ==========================================
        // 3. PLAYER LOGIC
        // ==========================================

        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => loadAndPlay(evt.target.result);
                reader.readAsDataURL(file);
            }
        };

        function loadAndPlay(src) {
            // Stop Recording if active
            if (isScanning) {
                isScanning = false;
                cancelAnimationFrame(animationId);
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
            }

            const img = new Image();
            img.onload = () => {
                // Draw image to main canvas
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                loadedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                startPlayback();
            };
            img.src = src;
        }

        function startPlayback() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            isPlaying = true;
            stopBtn.style.display = 'inline-block';
            scanLine.style.display = 'block';
            status.textContent = "Playing Sound from Image...";
            
            const startTime = performance.now();
            
            function playLoop() {
                if (!isPlaying) return;
                
                const elapsed = performance.now() - startTime;
                // Loop playback if needed, or just run once? Let's run once per 15s cycle
                const progress = (elapsed % SCAN_DURATION_MS) / SCAN_DURATION_MS;
                
                // Visual Indicator
                scanLine.style.transform = `translate(-50%, -50%) rotate(${progress * 360}deg) translate(50%, 0)`;

                synthesizeSound(progress * Math.PI * 2);
                requestAnimationFrame(playLoop);
            }
            playLoop();
        }

        function synthesizeSound(angle) {
            // Stop old oscillators
            oscs.forEach(o => { o.stop(); o.disconnect(); });
            oscs = [];

            if (!loadedImageData) return;

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const maxRadius = cx;
            const pixels = loadedImageData.data;
            const steps = 35; // Number of tones to play simultaneously

            for (let i = 1; i < steps; i++) {
                const percent = i / steps;
                const r = percent * maxRadius;
                
                // Get Pixel coords at scan line
                const x = Math.floor(cx + Math.cos(angle) * r);
                const y = Math.floor(cy + Math.sin(angle) * r);

                // Bounds check
                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;

                const pIndex = (y * canvas.width + x) * 4;
                // Brightness = (R+G+B)/3
                const brightness = (pixels[pIndex] + pixels[pIndex+1] + pixels[pIndex+2]) / 3;

                if (brightness > 40) {
                    // Inverse Log Mapping to get Frequency back
                    // Reversing: frequency increases exponentially with radius
                    const frequency = 50 + (Math.pow(100, percent) * 150); 
                    
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc.type = 'sine'; // Sine waves sound smoothest
                    osc.frequency.value = frequency;
                    
                    // Volume based on pixel brightness
                    gain.gain.value = (brightness / 255) * 0.04; 

                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    oscs.push(osc);
                }
            }
        }

        function stopPlayback() {
            isPlaying = false;
            stopBtn.style.display = 'none';
            scanLine.style.display = 'none';
            oscs.forEach(o => o.stop());
            status.textContent = "Ready.";
        }
        
        stopBtn.onclick = stopPlayback;

    </script>
</body>
</html>
