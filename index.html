<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soundscape: Record & Play</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Container */
        .radar-wrapper {
            position: relative;
            width: 95vw; height: 95vw;
            max-width: 600px; max-height: 600px;
            margin-top: 10px;
            border-radius: 50%;
            border: 2px solid #333;
            background: #000;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,255,0,0.1);
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* Controls Section */
        .controls-area {
            margin: 15px; padding: 10px;
            background: #111; border-radius: 10px;
            display: flex; flex-direction: column; gap: 10px; align-items: center;
            width: 90%; max-width: 600px;
        }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        
        button {
            padding: 10px 20px; font-size: 14px; border: none; border-radius: 5px; 
            cursor: pointer; color: white; font-weight: bold; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }

        /* Colors */
        .btn-rec { background: #e74c3c; }
        .btn-pause { background: #f39c12; }
        .btn-resume { background: #2980b9; }
        .btn-save { background: #8e44ad; }
        .btn-upload { background: #27ae60; }
        .btn-stop { background: #7f8c8d; }

        /* Status Text */
        #status { font-family: monospace; color: #0f0; margin-bottom: 5px; font-size: 14px; }
        
        /* Hidden Input */
        input[type="file"] { display: none; }
        
        /* Player Scan Line */
        #scanLine {
            position: absolute; top: 50%; left: 50%; width: 50%; height: 2px;
            background: #fff; transform-origin: 0 0; display: none; pointer-events: none;
            box-shadow: 0 0 10px white; z-index: 10;
        }
    </style>
</head>
<body>

    <div class="controls-area">
        <div id="status">Ready. Select Mode.</div>
        
        <div class="btn-group" id="recControls">
            <button class="btn-rec" id="startBtn">üé§ Start Scan</button>
            <button class="btn-pause" id="pauseBtn" style="display:none;">‚è∏ Pause</button>
            <button class="btn-resume" id="resumeBtn" style="display:none;">‚ñ∂ Resume</button>
            <button class="btn-save" id="saveBtn" style="display:none;">üíæ Save Image</button>
        </div>

        <div class="btn-group" style="border-top: 1px solid #333; padding-top:10px; margin-top:5px; width:100%;">
            <button class="btn-upload" onclick="document.getElementById('fileInput').click()">üìÇ Upload & Play</button>
            <input type="file" id="fileInput" accept="image/*">
            <button class="btn-stop" id="stopBtn" style="display:none;">‚èπ Stop Playing</button>
        </div>
    </div>

    <div class="radar-wrapper">
        <canvas id="radar" width="1200" height="1200"></canvas>
        <div id="scanLine"></div>
    </div>

    <script>
        // --- SETUP ---
        const canvas = document.getElementById('radar');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const status = document.getElementById('status');
        const scanLine = document.getElementById('scanLine');

        // Buttons
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const saveBtn = document.getElementById('saveBtn');
        const stopBtn = document.getElementById('stopBtn');

        // State Variables
        let audioCtx, analyser, dataArray, source, stream;
        let isScanning = false;
        let isPaused = false;
        let isPlaying = false;
        let angle = 0;
        let animationId;
        let loadedImageData = null;
        let oscs = []; // Oscillators for playback

        // Settings
        const SCAN_SPEED = 0.003; // Scanning Speed
        const PLAY_DURATION = 15000; // 15 Seconds per rotation for playback

        // Initialize Black Screen
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ==========================================
        // 1. RECORDING (SCANNER) LOGIC
        // ==========================================

        startBtn.onclick = async () => {
            stopPlayback(); // Stop player if running
            try {
                if (!stream) {
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 4096;
                analyser.smoothingTimeConstant = 0.5;
                source.connect(analyser);
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // UI Updates
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                saveBtn.style.display = 'inline-block';
                status.textContent = "Scanning... (Infinite Loop)";
                
                isScanning = true;
                isPaused = false;
                loopScan();

            } catch (err) {
                alert("Mic Error: " + err.message);
            }
        };

        pauseBtn.onclick = () => { isPaused = true; togglePauseUI(true); };
        resumeBtn.onclick = () => { isPaused = false; togglePauseUI(false); };

        function togglePauseUI(paused) {
            pauseBtn.style.display = paused ? 'none' : 'inline-block';
            resumeBtn.style.display = paused ? 'inline-block' : 'none';
            status.textContent = paused ? "Paused." : "Scanning...";
        }

        function loopScan() {
            if (!isScanning) return;
            animationId = requestAnimationFrame(loopScan);
            if (isPaused) return;

            analyser.getByteFrequencyData(dataArray);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const maxRadius = cx;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angle);

            // 1. Wiper Effect (Clear ahead)
            ctx.fillStyle = '#000';
            ctx.fillRect(0, -4, maxRadius, 10); 

            // 2. Draw Frequency
            const startBin = 5;
            const endBin = dataArray.length * 0.75;
            const totalBins = endBin - startBin;

            for (let r = 0; r < maxRadius; r += 2) {
                // Logarithmic Mapping
                const percent = r / maxRadius;
                const logIndex = startBin + (totalBins * (Math.pow(100, percent) - 1) / 99);
                const index = Math.floor(logIndex);
                const value = dataArray[index] || 0;

                if (value > 8) { // Noise Gate
                    const hue = 270 - (percent * 270); // Violet -> Red
                    const lightness = 5 + (value / 255) * 65; // Brightness
                    
                    ctx.fillStyle = `hsl(${hue}, 100%, ${lightness}%)`;
                    ctx.fillRect(r, 0, 4, 3);
                }
            }
            ctx.restore();

            angle += SCAN_SPEED;
            if (angle >= Math.PI * 2) angle = 0; // Infinite Loop
        }

        // ==========================================
        // 2. SAVING (WATERMARK) LOGIC
        // ==========================================

        saveBtn.onclick = () => {
            const wasPaused = isPaused;
            isPaused = true; // Pause momentarily

            // Create Watermarked Canvas
            const tempCanvas = document.createElement('canvas');
            const footerH = 150;
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height + footerH;
            const tCtx = tempCanvas.getContext('2d');

            // Draw Background & Radar
            tCtx.fillStyle = '#000';
            tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tCtx.drawImage(canvas, 0, 0);

            // Draw Watermark
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB');
            const timeStr = now.toLocaleTimeString('en-US');
            const urlStr = window.location.href;

            tCtx.textAlign = 'center';
            tCtx.fillStyle = '#fff';
            tCtx.font = 'bold 40px monospace';
            tCtx.fillText(`${dateStr} | ${timeStr}`, tempCanvas.width/2, canvas.height + 60);
            
            tCtx.fillStyle = '#aaa';
            tCtx.font = '24px sans-serif';
            tCtx.fillText(urlStr, tempCanvas.width/2, canvas.height + 110);

            // Download
            const link = document.createElement('a');
            link.download = `Soundscape_${Date.now()}.jpg`;
            link.href = tempCanvas.toDataURL('image/jpeg', 0.9);
            link.click();

            if (!wasPaused) isPaused = false; // Resume if needed
        };

        // ==========================================
        // 3. PLAYER (PLAYBACK) LOGIC
        // ==========================================

        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                stopScanning(); // Stop recording mode
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        loadedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        startPlayback();
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        function stopScanning() {
            isScanning = false;
            cancelAnimationFrame(animationId);
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            saveBtn.style.display = 'none';
        }

        function startPlayback() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            isPlaying = true;
            stopBtn.style.display = 'inline-block';
            scanLine.style.display = 'block';
            status.textContent = "Playing Sound from Image...";
            
            const startTime = performance.now();
            
            function playLoop() {
                if (!isPlaying) return;
                
                const elapsed = performance.now() - startTime;
                const progress = (elapsed % PLAY_DURATION) / PLAY_DURATION;
                const angleRad = progress * Math.PI * 2;

                // Move Scan Line
                scanLine.style.transform = `translate(-50%, -50%) rotate(${progress * 360}deg) translate(50%, 0)`;

                synthesizeSound(angleRad);
                requestAnimationFrame(playLoop);
            }
            playLoop();
        }

        function synthesizeSound(angle) {
            // Stop old oscillators
            oscs.forEach(o => { o.stop(); o.disconnect(); });
            oscs = [];

            if (!loadedImageData) return;

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const maxRadius = cx;
            const pixels = loadedImageData.data;
            const steps = 30; // Quality of synthesis

            for (let i = 1; i < steps; i++) {
                const percent = i / steps;
                const r = percent * maxRadius;
                
                // Get Pixel coords
                const x = Math.floor(cx + Math.cos(angle) * r);
                const y = Math.floor(cy + Math.sin(angle) * r);

                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;

                const pIndex = (y * canvas.width + x) * 4;
                const brightness = (pixels[pIndex] + pixels[pIndex+1] + pixels[pIndex+2]) / 3;

                if (brightness > 30) {
                    // Inverse Log Mapping (Radius -> Frequency)
                    const frequency = 50 + (Math.pow(100, percent) * 200); 
                    
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.value = frequency;
                    gain.gain.value = (brightness / 255) * 0.05; // Low volume

                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    oscs.push(osc);
                }
            }
        }

        function stopPlayback() {
            isPlaying = false;
            stopBtn.style.display = 'none';
            scanLine.style.display = 'none';
            oscs.forEach(o => o.stop());
            status.textContent = "Playback Stopped.";
        }
        
        stopBtn.onclick = stopPlayback;

    </script>
</body>
</html>
