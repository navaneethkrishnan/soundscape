<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Soundscape Generator</title>
    <style>
        body { 
            margin: 0; 
            background: #111; 
            color: #eee; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        /* Main Radar Area */
        .radar-container {
            position: relative;
            margin-top: 20px;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
            border-radius: 50%;
            overflow: hidden;
            background: #000;
            /* ‡¥°‡¥ø‡¥∏‡µç‡¥™‡µç‡¥≤‡µá‡¥Ø‡¥ø‡µΩ ‡¥ï‡¥æ‡¥£‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µÄ‡¥®‡¥ø‡µΩ ‡¥í‡¥§‡µÅ‡¥ô‡µç‡¥ô‡¥æ‡µª, ‡¥™‡¥ï‡µç‡¥∑‡µÜ ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡¥§‡µç ‡¥µ‡¥≤‡¥ø‡¥Ø ‡¥∏‡µà‡¥∏‡¥ø‡µΩ ‡¥Ü‡¥Ø‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Ç */
            width: 95vw;
            height: 95vw;
            max-width: 500px;
            max-height: 500px;
        }
        
        canvas { 
            width: 100%; 
            height: 100%; 
        }
        
        /* Controls */
        .controls { 
            margin: 20px; 
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:active { transform: scale(0.95); }

        #startBtn { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        #pauseBtn { background: #f39c12; display: none; }
        #resumeBtn { background: #2980b9; display: none; }

        /* Gallery Section */
        #gallery {
            width: 90%;
            max-width: 600px;
            margin-bottom: 50px;
        }
        .gallery-item {
            background: #222;
            border: 1px solid #444;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            animation: fadeIn 0.5s;
        }
        .gallery-item img {
            width: 100%;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .gallery-actions {
            margin-top: 10px;
            text-align: center;
        }
        .save-btn {
            background: #8e44ad;
            color: white;
            padding: 8px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            display: inline-block;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="controls">
        <button id="startBtn">üé§ ‡¥Æ‡µà‡¥ï‡µç‡¥∞‡µã‡¥´‡µã‡µ∫ ‡¥ì‡µ∫ ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
        <button id="pauseBtn">‚è∏ Pause</button>
        <button id="resumeBtn">‚ñ∂ Continue</button>
    </div>
    
    <div id="status" style="margin-bottom: 10px; font-size: 14px; color: #aaa;"></div>

    <div class="radar-container">
        <canvas id="radar" width="1000" height="1000"></canvas>
    </div>

    <h3 style="margin-top: 30px; border-bottom: 1px solid #444; padding-bottom: 5px; width: 90%; max-width: 600px;">
        ‡¥ó‡¥æ‡¥≤‡¥±‡¥ø (Saved Scans)
    </h3>
    <div id="gallery"></div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const canvas = document.getElementById('radar');
        const ctx = canvas.getContext('2d');
        const gallery = document.getElementById('gallery');
        const statusDiv = document.getElementById('status');

        let isScanning = false;
        let isPaused = false;
        let angle = 0;
        const scanSpeed = 0.008; // ‡¥∏‡µç‡¥™‡µÄ‡¥°‡µç ‡¥ï‡µç‡¥∞‡¥Æ‡µÄ‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç

        // Initialize black background
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        startBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Button visibility toggle
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                statusDiv.textContent = "Scanning Active...";
                
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                const analyser = audioCtx.createAnalyser();
                
                analyser.fftSize = 2048; // ‡¥®‡¥≤‡µç‡¥≤ ‡¥±‡µÜ‡¥∏‡¥≤‡µç‡¥Ø‡µÇ‡¥∑‡¥®‡µç ‡¥µ‡µá‡¥£‡µç‡¥ü‡¥ø
                source.connect(analyser);

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                isScanning = true;
                draw(analyser, dataArray, bufferLength);

            } catch (err) {
                alert("Error: " + err.message);
            }
        };

        pauseBtn.onclick = () => {
            isPaused = true;
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'inline-block';
            statusDiv.textContent = "Paused";
        };

        resumeBtn.onclick = () => {
            isPaused = false;
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            statusDiv.textContent = "Scanning Active...";
        };

        function draw(analyser, dataArray, bufferLength) {
            requestAnimationFrame(() => draw(analyser, dataArray, bufferLength));

            if (!isScanning || isPaused) return;

            analyser.getByteFrequencyData(dataArray);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const maxRadius = cx; // ‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥Ç ‡¥ï‡µç‡¥Ø‡¥æ‡µª‡¥µ‡¥æ‡¥∏‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥Ö‡¥±‡µç‡¥±‡¥Ç ‡¥µ‡¥∞‡µÜ ‡¥é‡¥§‡µç‡¥§‡µÅ‡¥Ç

            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angle);

            // Drawing Logic
            for (let i = 0; i < bufferLength; i++) {
                const value = dataArray[i];
                
                // Color Mapping: Violet (Low) -> Red (High)
                const hue = 270 - ((i / bufferLength) * 270);
                const lightness = (value / 255) * 50; 
                
                if (value > 10) {
                    // Start radius pushed out slightly to leave a small hole in center (optional)
                    const startR = (i / bufferLength) * maxRadius;
                    // Make blocks slightly wider to avoid gaps
                    const endR = startR + (maxRadius / bufferLength) * 3; 
                    
                    ctx.fillStyle = `hsl(${hue}, 100%, ${lightness}%)`;
                    // Drawing slightly thicker lines for visibility
                    ctx.fillRect(startR, -2, (endR - startR), 4); 
                }
            }
            ctx.restore();

            angle += scanSpeed;

            // Full rotation check
            if (angle >= Math.PI * 2) {
                processCompletedScan();
                // Reset
                angle = 0;
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        function processCompletedScan() {
            // 1. Create a larger temporary canvas for watermark
            const tempCanvas = document.createElement('canvas');
            const footerHeight = 80; // Space for text
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height + footerHeight;
            const tCtx = tempCanvas.getContext('2d');

            // 2. Fill Background
            tCtx.fillStyle = '#000';
            tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // 3. Draw the Radar Image
            tCtx.drawImage(canvas, 0, 0);

            // 4. Add Watermark Text
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-IN');
            const timeStr = now.toLocaleTimeString('en-IN');
            const siteUrl = window.location.href; // Current Page URL

            tCtx.fillStyle = '#fff';
            tCtx.font = '24px monospace';
            tCtx.textAlign = 'center';
            
            // Text Line 1: Title and Date
            tCtx.fillText(`Soundscape Scan | ${dateStr} ${timeStr}`, tempCanvas.width / 2, canvas.height + 30);
            
            // Text Line 2: URL
            tCtx.fillStyle = '#888';
            tCtx.font = '16px sans-serif';
            tCtx.fillText(`Generated at: ${siteUrl}`, tempCanvas.width / 2, canvas.height + 60);

            // 5. Generate Image URL and Add to Gallery
            const finalImageURL = tempCanvas.toDataURL("image/jpeg", 0.9);
            addToGallery(finalImageURL, timeStr, dateStr);
        }

        function addToGallery(url, time, date) {
            const filename = `soundscape_${date.replace(/\//g,'-')}_${time.replace(/:/g,'-')}.jpg`;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'gallery-item';
            
            itemDiv.innerHTML = `
                <img src="${url}" alt="Soundscape">
                <div class="gallery-actions">
                    <a href="${url}" download="${filename}" class="save-btn">üíæ Save Image with Details</a>
                </div>
            `;

            gallery.insertBefore(itemDiv, gallery.firstChild);
        }
    </script>
</body>
</html>
