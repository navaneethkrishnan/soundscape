<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soundscape Fixed</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .radar-box {
            position: relative; margin-top: 10px;
            width: 95vw; height: 95vw; max-width: 500px; max-height: 500px;
            border-radius: 50%; border: 3px solid #333; background: #000;
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }

        .btn-area {
            margin: 15px; padding: 10px; background: #111; border-radius: 10px;
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
        }
        button { padding: 10px 20px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-start { background: #e74c3c; }
        .btn-stop { background: #7f8c8d; }
        .btn-upload { background: #27ae60; }
        
        #msg { color: #f39c12; font-size: 12px; margin-bottom: 5px; font-family: monospace; }
        
        /* Playback Line */
        #line {
            position: absolute; top: 50%; left: 50%; width: 50%; height: 2px;
            background: #fff; transform-origin: 0 0; display: none; pointer-events: none;
            box-shadow: 0 0 5px white; z-index: 10;
        }

        /* Gallery */
        #gallery { width: 90%; max-width: 500px; margin-bottom: 50px; display: flex; flex-direction: column; gap: 10px; }
        .card { background: #222; padding: 10px; border-radius: 8px; display: flex; gap: 10px; align-items: center; border: 1px solid #444; }
        .card img { width: 80px; height: 80px; object-fit: cover; border: 1px solid #666; cursor: pointer; }
        .card-info { font-size: 11px; color: #ccc; flex: 1; }
        .btn-save { background: #444; color: white; text-decoration: none; padding: 5px 10px; font-size: 11px; border-radius: 4px; display: inline-block; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="btn-area">
        <button class="btn-start" id="startBtn">üî¥ Start Loop Recording</button>
        <button class="btn-stop" id="stopBtn" style="display:none;">‚èπ Stop Playback</button>
        <button class="btn-upload" onclick="document.getElementById('up').click()">üìÇ Upload & Play</button>
        <input type="file" id="up" accept="image/png" style="display:none">
    </div>

    <div id="msg">Ready.</div>

    <div class="radar-box">
        <canvas id="cvs" width="800" height="800"></canvas>
        <div id="line"></div>
    </div>

    <h3 style="color:#666; font-size:12px; margin-top:20px;">SAVED LOOPS (Click Image to Play)</h3>
    <div id="gallery"></div>

    <script>
        const DURATION = 15000; // 15 Seconds
        const SPEED = (Math.PI * 2) / (DURATION / 16.6);

        const canvas = document.getElementById('cvs');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const msg = document.getElementById('msg');
        const line = document.getElementById('line');
        const gallery = document.getElementById('gallery');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        let audioCtx, analyser, dataArray, stream;
        let recorder, chunks = [];
        let isRec = false, angle = 0, loopId;
        let player = null;
        let tempSnapshot = null; // To hold the image before wipe

        // Black Screen Init
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,800,800);

        // --- RECORDING ---
        startBtn.onclick = async () => {
            if(player) stopPlay();
            try {
                if(!stream) stream = await navigator.mediaDevices.getUserMedia({audio:true});
                
                // Visual Setup
                if(!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const src = audioCtx.createMediaStreamSource(stream);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 2048;
                    src.connect(analyser);
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                }

                setupRecorder();

                startBtn.style.display = 'none';
                msg.textContent = "Recording... (Looping every 15s)";
                
                isRec = true;
                angle = 0;
                ctx.fillStyle='#000'; ctx.fillRect(0,0,800,800);
                
                recorder.start();
                draw();

            } catch(e) { alert("Mic Error: "+e); }
        };

        function setupRecorder() {
            recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            chunks = [];
            
            recorder.ondataavailable = e => chunks.push(e.data);
            
            recorder.onstop = async () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                chunks = [];
                // Save using the SNAPSHOT we took before wipe
                if(tempSnapshot) process(blob, tempSnapshot);
            };
        }

        function draw() {
            if(!isRec) return;
            loopId = requestAnimationFrame(draw);

            analyser.getByteFrequencyData(dataArray);

            const cx = 400, cy = 400, maxR = 390;
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angle);

            // Draw Frequency
            const len = dataArray.length * 0.7;
            for(let r=0; r<maxR; r+=4) { // Step 4 for performance
                const val = dataArray[Math.floor((r/maxR)*len)];
                if(val > 10) {
                    const hue = 270 - (r/maxR)*270;
                    const light = 10 + (val/255)*50;
                    ctx.fillStyle = `hsl(${hue}, 100%, ${light}%)`;
                    ctx.fillRect(r, -2, 6, 6);
                }
            }
            // Scanner Head
            ctx.fillStyle='#fff'; ctx.fillRect(maxR-10, -1, 10, 2);
            ctx.restore();

            angle += SPEED;

            // LOOP END CHECK
            if(angle >= Math.PI*2) {
                // 1. TAKE SNAPSHOT (Crucial Step!)
                const snap = document.createElement('canvas');
                snap.width = 800; snap.height = 800;
                snap.getContext('2d').drawImage(canvas, 0, 0);
                tempSnapshot = snap; // Save for processor

                // 2. Trigger Audio Save
                recorder.stop();

                // 3. Reset
                angle = 0;
                ctx.fillStyle='#000'; ctx.fillRect(0,0,800,800);
                
                // 4. Restart Recorder
                setTimeout(() => { if(isRec) recorder.start(); }, 50);
            }
        }

        // --- PROCESSING (Combine Image + Audio) ---
        function process(audioBlob, imageCanvas) {
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                const b64 = reader.result;
                embed(imageCanvas, b64);
            };
        }

        function embed(imgCvs, audioStr) {
            // New Canvas with extra space at bottom
            const final = document.createElement('canvas');
            final.width = 800; final.height = 950; // 800 + 150 for data
            const fCtx = final.getContext('2d');

            fCtx.fillStyle='#000'; fCtx.fillRect(0,0,800,950);
            fCtx.drawImage(imgCvs, 0, 0); // Draw the snapshot

            // Embed Audio as Pixels at bottom
            const str = "###S###" + audioStr + "###E###";
            let x=0, y=805;
            
            fCtx.fillStyle='#333'; fCtx.fillRect(0,800,800,2); // Line
            
            for(let i=0; i<str.length; i++) {
                const c = str.charCodeAt(i);
                fCtx.fillStyle = `rgb(${c}, ${c%100}, 100)`;
                fCtx.fillRect(x, y, 2, 2);
                x+=2;
                if(x>=800) { x=0; y+=2; }
            }

            // Watermark
            const t = new Date();
            fCtx.fillStyle='#fff'; fCtx.textAlign='center'; 
            fCtx.font='bold 20px monospace';
            fCtx.fillText(t.toLocaleTimeString(), 400, 930);

            // Add to Gallery
            const url = final.toDataURL("image/png");
            addCard(url, t.toLocaleTimeString());
        }

        function addCard(url, time) {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <img src="${url}" onclick="play('${url}')">
                <div class="card-info">
                    <b>Rec: ${time}</b><br>
                    <span>Click Image to Play</span>
                </div>
                <a href="${url}" download="Sound_${Date.now()}.png" class="btn-save">üíæ Save PNG</a>
            `;
            gallery.prepend(div);
        }

        // --- PLAYBACK ---
        document.getElementById('up').onchange = e => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => play(ev.target.result);
                r.readAsDataURL(f);
            }
        };

        function play(src) {
            if(isRec) { // Stop recording if playing
                isRec=false; cancelAnimationFrame(loopId); recorder.stop();
                startBtn.style.display='inline-block';
            }
            if(player) player.pause();
            
            msg.textContent = "Decoding...";
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0, 800, 800); // Draw Visual
                
                // Read Audio Pixels
                const tC = document.createElement('canvas');
                tC.width=img.width; tC.height=img.height;
                const tX = tC.getContext('2d');
                tX.drawImage(img,0,0);
                
                const data = tX.getImageData(0, 805, img.width, 145).data;
                let str = "";
                // Decode pixels
                for(let i=0; i<data.length; i+=8) { // Jump 2 pixels (2x2 rect = 4 channels * 2) -> approx logic
                     // Since we drew 2x2 rectangles, we can just sample every 2nd pixel
                     // But simpler: just scan R channel
                     const r = data[i];
                     if(r) str += String.fromCharCode(r);
                }
                
                // Extract
                const s = str.indexOf("###S###");
                const e = str.indexOf("###E###");
                if(s!==-1 && e!==-1) {
                    const audioSrc = str.substring(s+7, e);
                    playSound(audioSrc);
                } else {
                    alert("No Audio Found in this image!");
                    msg.textContent = "Error.";
                }
            };
            img.src = src;
        }

        function playSound(b64) {
            player = new Audio(b64);
            player.play();
            line.style.display='block'; stopBtn.style.display='inline-block';
            msg.textContent = "Playing Real Audio...";

            const startT = Date.now();
            function ani() {
                if(!player || player.paused) return;
                requestAnimationFrame(ani);
                const p = ((Date.now()-startT)%DURATION)/DURATION;
                line.style.transform = `translate(-50%,-50%) rotate(${p*360}deg) translate(50%,0)`;
            }
            ani();
            
            player.onended = stopPlay;
        }

        function stopPlay() {
            if(player) player.pause();
            line.style.display='none'; stopBtn.style.display='none';
            msg.textContent = "Ready.";
        }
        stopBtn.onclick = stopPlay;

    </script>
</body>
</html>
