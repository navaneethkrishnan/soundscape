<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Voice Soundscape</title>
    <style>
        body { margin: 0; background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .radar-container {
            position: relative; margin-top: 20px;
            width: 95vw; height: 95vw; max-width: 500px; max-height: 500px;
            border-radius: 50%; border: 3px solid #333; background: #000;
            overflow: hidden; box-shadow: 0 0 30px rgba(0,255,0,0.1);
        }
        canvas { display: block; width: 100%; height: 100%; }

        .controls {
            margin: 15px; padding: 10px; background: #111; border-radius: 12px;
            display: flex; gap: 10px; justify-content: center; width: 90%; max-width: 500px;
        }
        button { padding: 10px 20px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; }
        .btn-start { background: #e74c3c; }
        .btn-stop { background: #7f8c8d; }

        #status { font-family: monospace; color: #0f0; margin-bottom: 5px; font-size: 13px; }
        
        #scanLine {
            position: absolute; top: 50%; left: 50%; width: 50%; height: 2px;
            background: #fff; transform-origin: 0 0; display: none; pointer-events: none;
            box-shadow: 0 0 8px white; z-index: 10;
        }

        #gallery {
            width: 95%; max-width: 500px; margin-bottom: 50px; margin-top: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .gallery-item {
            background: #151515; border: 1px solid #333; padding: 10px; border-radius: 8px;
            display: flex; gap: 10px; align-items: center; animation: slideDown 0.4s ease;
        }
        .gallery-item img {
            width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #444; cursor: pointer;
        }
        .gallery-info { flex: 1; font-size: 12px; color: #aaa; }
        .btn-dl { background: #27ae60; padding: 5px 10px; font-size: 11px; text-decoration: none; display: inline-block; margin-top: 5px; color: white; border-radius: 3px; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="controls">
        <button class="btn-start" id="startBtn">üé§ Start Recording</button>
        <button class="btn-stop" id="stopBtn" style="display:none;">‚èπ Stop Playback</button>
    </div>

    <div id="status">Ready. Loops every 15s.</div>

    <div class="radar-container">
        <canvas id="radar" width="1000" height="1000"></canvas>
        <div id="scanLine"></div>
    </div>

    <h3 style="color:#444; font-size:12px; text-transform:uppercase; margin-top:20px;">Gallery (Click Image to Play Audio)</h3>
    <div id="gallery"></div>

    <script>
        const SCAN_DURATION_MS = 15000; 
        const SCAN_SPEED = (Math.PI * 2) / (SCAN_DURATION_MS / 16.6);

        const canvas = document.getElementById('radar');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const status = document.getElementById('status');
        const scanLine = document.getElementById('scanLine');
        const gallery = document.getElementById('gallery');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        let audioCtx, analyser, dataArray, stream;
        let mediaRecorder;
        let audioChunks = [];
        let isScanning = false;
        let angle = 0;
        let currentAudio = null; // To handle playback
        let recordingStartTime = 0;

        // Initialize Canvas
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // --- START RECORDING ---
        startBtn.onclick = async () => {
            if (currentAudio) { currentAudio.pause(); scanLine.style.display = 'none'; }
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 1. Setup Visualizer Audio Context
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 4096;
                analyser.smoothingTimeConstant = 0.5;
                source.connect(analyser);
                
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                // 2. Setup Real Audio Recorder
                setupMediaRecorder();

                // UI
                startBtn.style.display = 'none';
                status.textContent = "Recording Real Audio... (Looping)";
                
                // Start Loop
                angle = 0;
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                isScanning = true;
                
                mediaRecorder.start(); // Start recording audio
                recordingStartTime = Date.now();
                loopScan();

            } catch (err) {
                alert("Error: " + err.message);
            }
        };

        function setupMediaRecorder() {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                // When 15s ends, save data
                saveToGallery();
                // If still scanning, restart recorder immediately
                if (isScanning) {
                    audioChunks = [];
                    mediaRecorder.start();
                }
            };
        }

        // --- VISUAL LOOP ---
        function loopScan() {
            if (!isScanning) return;
            requestAnimationFrame(loopScan);

            analyser.getByteFrequencyData(dataArray);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const maxRadius = cx;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angle);

            // Logarithmic Draw
            const startBin = 5;
            const endBin = dataArray.length * 0.75;
            const totalBins = endBin - startBin;

            for (let r = 0; r < maxRadius; r += 2) {
                const percent = r / maxRadius;
                const logIndex = startBin + (totalBins * (Math.pow(100, percent) - 1) / 99);
                const value = dataArray[Math.floor(logIndex)] || 0;

                if (value > 10) {
                    const hue = 270 - (percent * 270);
                    const lightness = 5 + (value / 255) * 60;
                    ctx.fillStyle = `hsl(${hue}, 100%, ${lightness}%)`;
                    ctx.fillRect(r, -2, 4, 4);
                }
            }
            
            // Scanner Head
            ctx.fillStyle = '#fff';
            ctx.fillRect(maxRadius - 10, -1, 10, 2);
            ctx.restore();

            angle += SCAN_SPEED;

            // Check 15 Seconds
            if (angle >= Math.PI * 2) {
                angle = 0;
                // Stop recorder to save chunk, it will auto-restart in onstop
                mediaRecorder.stop();
                
                // Clear Canvas
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        // --- SAVE TO GALLERY ---
        async function saveToGallery() {
            // 1. Create Audio Blob (Real Voice)
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const audioUrl = URL.createObjectURL(audioBlob);

            // 2. Create Image (Visual) - with Watermark
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 1000; tempCanvas.height = 1150;
            const tCtx = tempCanvas.getContext('2d');
            
            tCtx.fillStyle = '#000'; tCtx.fillRect(0, 0, 1000, 1150);
            tCtx.drawImage(canvas, 0, 0);
            
            const now = new Date();
            tCtx.fillStyle = '#fff'; tCtx.font = 'bold 30px monospace'; tCtx.textAlign = 'center';
            tCtx.fillText(now.toLocaleString(), 500, 1050);
            tCtx.fillStyle = '#888'; tCtx.font = '20px sans-serif';
            tCtx.fillText("Includes Real Audio Recording", 500, 1100);

            const imgUrl = tempCanvas.toDataURL("image/jpeg", 0.8);

            // 3. Create Video Blob (For Download)
            // Note: Generating a real video file client-side is heavy. 
            // Here we just provide the Audio file and Image file separately or combining them manually.
            // For simplicity in this demo, download button downloads the AUDIO file, 
            // but the Gallery plays it synced.

            addToGalleryUI(imgUrl, audioUrl, now.toLocaleTimeString());
        }

        function addToGalleryUI(imgUrl, audioUrl, time) {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.innerHTML = `
                <img src="${imgUrl}">
                <div class="gallery-info">
                    <strong>Recorded at ${time}</strong><br>
                    <span style="color:#2ecc71">‚ñ∂ Click Play to hear Voice</span>
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <a href="${audioUrl}" download="voice_${Date.now()}.webm" class="btn-dl">üíæ Save Audio</a>
                    <a href="${imgUrl}" download="scan_${Date.now()}.jpg" class="btn-dl" style="background:#8e44ad">üíæ Save Image</a>
                </div>
            `;
            
            // Play Logic
            const img = div.querySelector('img');
            img.onclick = () => playRecord(imgUrl, audioUrl);

            gallery.prepend(div);
        }

        // --- PLAYBACK LOGIC ---
        function playRecord(imgUrl, audioUrl) {
            // Stop scanning if active
            if (isScanning) {
                isScanning = false;
                mediaRecorder.stop();
                startBtn.style.display = 'inline-block';
                status.textContent = "Recording Stopped.";
            }
            if (currentAudio) currentAudio.pause();

            // Load Image
            const img = new Image();
            img.src = imgUrl;
            img.onload = () => {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };

            // Play Audio
            currentAudio = new Audio(audioUrl);
            currentAudio.play();
            status.textContent = "Playing Real Recording...";
            stopBtn.style.display = 'inline-block';
            scanLine.style.display = 'block';

            // Animate Scanline
            const startPlayTime = Date.now();
            
            function animatePlay() {
                if (!currentAudio || currentAudio.paused) {
                    scanLine.style.display = 'none';
                    stopBtn.style.display = 'none';
                    status.textContent = "Ready.";
                    return;
                }
                requestAnimationFrame(animatePlay);

                const elapsed = (Date.now() - startPlayTime) % SCAN_DURATION_MS;
                const progress = elapsed / SCAN_DURATION_MS;
                scanLine.style.transform = `translate(-50%, -50%) rotate(${progress * 360}deg) translate(50%, 0)`;
            }
            animatePlay();
        }

        stopBtn.onclick = () => {
            if (currentAudio) currentAudio.pause();
        };

    </script>
</body>
</html>
