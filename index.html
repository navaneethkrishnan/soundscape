<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Infinity Soundscape</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .radar-box {
            position: relative; margin-top: 15px;
            width: 95vw; height: 95vw; max-width: 550px; max-height: 550px;
            border-radius: 50%; border: 4px solid #333; background: #000;
            overflow: hidden; box-shadow: 0 0 25px rgba(0,255,0,0.15);
        }
        canvas { display: block; width: 100%; height: 100%; }

        .controls {
            margin: 15px; padding: 12px; background: #111; border-radius: 12px;
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
            width: 95%; max-width: 600px; border: 1px solid #222;
        }
        button { padding: 10px 20px; font-size: 13px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }

        .btn-rec { background: #e74c3c; }
        .btn-stop { background: #7f8c8d; }
        .btn-up { background: #27ae60; }
        
        #status { color: #f1c40f; margin-bottom: 5px; font-size: 12px; font-family: monospace; }
        
        /* Playback Scan Line */
        #scanLine {
            position: absolute; top: 50%; left: 50%; width: 50%; height: 2px;
            background: #fff; transform-origin: 0 0; display: none; pointer-events: none;
            box-shadow: 0 0 8px white; z-index: 10;
        }

        /* Gallery */
        #gallery { width: 95%; max-width: 600px; margin-bottom: 60px; display: flex; flex-direction: column; gap: 15px; }
        .item { background: #1a1a1a; border: 1px solid #333; padding: 10px; border-radius: 8px; display: flex; gap: 12px; align-items: center; animation: fadeIn 0.5s; }
        .item img { width: 90px; height: 90px; object-fit: cover; border: 1px solid #555; cursor: pointer; border-radius: 4px; }
        .info { font-size: 11px; color: #aaa; flex: 1; }
        .btn-dl { display: inline-block; background: #333; color: white; text-decoration: none; padding: 6px 12px; border-radius: 4px; margin-top: 6px; font-size: 11px; border: 1px solid #444; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="controls">
        <button class="btn-rec" id="startBtn">üî¥ Start Loop</button>
        <button class="btn-stop" id="stopBtn" style="display:none;">‚èπ Stop Playback</button>
        <button class="btn-up" onclick="document.getElementById('fileIn').click()">üìÇ Upload & Play</button>
        <input type="file" id="fileIn" accept="image/png" style="display:none">
    </div>

    <div id="status">Ready.</div>

    <div class="radar-box">
        <canvas id="radar" width="1000" height="1000"></canvas>
        <div id="scanLine"></div>
    </div>

    <h3 style="color:#444; font-size:11px; margin-top:20px;">SAVED LOOPS (Auto-Saved)</h3>
    <div id="gallery"></div>

    <script>
        const LOOP_MS = 15000; // 15 Seconds
        const SPEED = (Math.PI * 2) / (LOOP_MS / 16.66);

        const canvas = document.getElementById('radar');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const scanLine = document.getElementById('scanLine');
        const status = document.getElementById('status');
        const gallery = document.getElementById('gallery');

        let audioCtx, analyser, dataArray, stream;
        let recorder, chunks = [];
        let isRec = false, angle = 0, animId;
        let player = null;
        let tempSnap = null; // Snapshot storage

        // Init Black Screen
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,1000,1000);

        // --- 1. RECORDING LOOP ---
        startBtn.onclick = async () => {
            if(player) stopPlayback();
            try {
                if(!stream) stream = await navigator.mediaDevices.getUserMedia({audio:true});
                
                // Visual Setup
                if(!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const src = audioCtx.createMediaStreamSource(stream);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 2048;
                    src.connect(analyser);
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                }

                setupRecorder();

                startBtn.style.display = 'none';
                status.textContent = "Recording... (Looping every 15s)";
                
                isRec = true; 
                angle = 0;
                ctx.fillStyle='#000'; ctx.fillRect(0,0,1000,1000); // Clear
                
                recorder.start();
                loopDraw();

            } catch(e) { alert("Mic Error: "+e); }
        };

        function setupRecorder() {
            recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            chunks = [];
            recorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
            
            // Loop End Action
            recorder.onstop = () => {
                const blob = new Blob(chunks, {type:'audio/webm'});
                chunks = [];
                // Process and Save using the SNAPSHOT taken before wipe
                if(tempSnap) processToImage(blob, tempSnap);
            };
        }

        function loopDraw() {
            if(!isRec) return;
            animId = requestAnimationFrame(loopDraw);

            analyser.getByteFrequencyData(dataArray);

            const cx = 500, cy = 500, maxR = 490;
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angle);

            // Draw Frequency
            const len = dataArray.length * 0.75;
            for(let r=0; r<maxR; r+=4) {
                const percent = r/maxR;
                const idx = Math.floor(5 + (len * (Math.pow(100, percent) - 1) / 99));
                const val = dataArray[idx] || 0;

                if(val > 10) {
                    const hue = 270 - (percent*270);
                    const light = 5 + (val/255)*65;
                    ctx.fillStyle = `hsl(${hue}, 100%, ${light}%)`;
                    ctx.fillRect(r, -2, 6, 6);
                }
            }
            // Scanner Head
            ctx.fillStyle='#fff'; ctx.fillRect(maxR-10, -1, 10, 2);
            ctx.restore();

            angle += SPEED;

            // CHECK LOOP END
            if(angle >= Math.PI*2) {
                // 1. Take Snapshot (Crucial: Before Wiping)
                const snap = document.createElement('canvas');
                snap.width = 1000; snap.height = 1000;
                snap.getContext('2d').drawImage(canvas, 0, 0);
                tempSnap = snap; 

                // 2. Stop Recorder (This triggers 'onstop' -> processToImage)
                recorder.stop(); 

                // 3. Reset Screen
                angle = 0;
                ctx.fillStyle='#000'; ctx.fillRect(0,0,1000,1000);

                // 4. Restart Recorder
                setTimeout(() => { if(isRec) recorder.start(); }, 50);
            }
        }

        // --- 2. ENCODING (Audio -> Pixels) ---
        function processToImage(audioBlob, visualSnap) {
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                const audioBase64 = reader.result;
                embedData(visualSnap, audioBase64);
            };
        }

        function embedData(imgCvs, b64) {
            // New Canvas with space at bottom
            const final = document.createElement('canvas');
            const dataH = 200; // Space for pixels
            const footH = 80;
            final.width = 1000; final.height = 1000 + dataH + footH;
            const fCtx = final.getContext('2d');

            // Draw Black BG & Visual
            fCtx.fillStyle='#000'; fCtx.fillRect(0,0,1000, final.height);
            fCtx.drawImage(imgCvs, 0, 0);

            // Separator Line
            fCtx.fillStyle='#333'; fCtx.fillRect(0,1000,1000,2);
            fCtx.font="14px monospace"; fCtx.fillStyle="#666"; fCtx.textAlign="center";
            fCtx.fillText("--- AUDIO DATA EMBEDDED BELOW ---", 500, 1015);

            // --- PIXEL ENCODING ---
            const str = "###S###" + b64 + "###E###";
            let x=0, y=1020;
            
            for(let i=0; i<str.length; i++) {
                const c = str.charCodeAt(i);
                // Store byte in RED channel. 
                // Green & Blue are used for 'techy' look
                fCtx.fillStyle = `rgb(${c}, 20, 50)`; 
                fCtx.fillRect(x, y, 2, 2); // 2x2 Pixel Block
                
                x+=2;
                if(x>=1000) { x=0; y+=2; }
            }

            // Watermark
            const t = new Date().toLocaleTimeString();
            fCtx.fillStyle='#fff'; fCtx.textAlign='center';
            fCtx.font='bold 24px monospace';
            fCtx.fillText(t, 500, final.height - 30);
            fCtx.font='16px sans-serif'; fCtx.fillStyle='#888';
            fCtx.fillText("Save as PNG to keep Audio", 500, final.height - 10);

            const url = final.toDataURL("image/png");
            addToGallery(url, t, b64);
        }

        function addToGallery(url, time, directAudio) {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <img src="${url}">
                <div class="info">
                    <b>Rec: ${time}</b><br>
                    <span style="color:#2ecc71">‚ñ∂ Click Image to Play</span>
                </div>
                <a href="${url}" download="Soundscape_${Date.now()}.png" class="btn-dl">üíæ Save PNG</a>
            `;
            
            // Optimization: If played immediately, use memory (fast)
            // If uploaded later, use pixel decoding.
            div.querySelector('img').onclick = () => {
                if(directAudio) playAudioString(directAudio); // Fast play
                else playFromPixels(url); // Should not happen here but good backup
            };
            gallery.prepend(div);
        }

        // --- 3. DECODING (Pixels -> Audio) ---
        // For Uploaded Files
        document.getElementById('fileIn').onchange = e => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => playFromPixels(ev.target.result);
                r.readAsDataURL(f);
            }
        };

        function playFromPixels(src) {
            stopPlayback();
            status.textContent = "Scanning Pixels for Audio...";
            
            const img = new Image();
            img.onload = () => {
                // Draw to canvas to read
                ctx.drawImage(img, 0, 0, 1000, 1000); // Visuals
                
                // Read Data Area
                const tC = document.createElement('canvas');
                tC.width = img.width; tC.height = img.height;
                const tX = tC.getContext('2d');
                tX.drawImage(img, 0, 0);
                
                // Scan pixels from y=1020
                const data = tX.getImageData(0, 1020, img.width, 300).data;
                let buffer = "";
                
                // Read every 2nd pixel (2x2 blocks)
                for(let i=0; i<data.length; i+=8) {
                    const r = data[i]; // Read Red Channel
                    if(r>0) buffer += String.fromCharCode(r);
                }

                const s = buffer.indexOf("###S###");
                const e = buffer.indexOf("###E###");

                if(s!==-1 && e!==-1) {
                    const b64 = buffer.substring(s+7, e);
                    playAudioString(b64);
                } else {
                    alert("No Audio Found! Make sure it is the original PNG.");
                    status.textContent = "Error: Decode Failed";
                }
            };
            img.src = src;
        }

        function playAudioString(b64) {
            player = new Audio(b64);
            player.play();
            status.textContent = "Playing Real Audio...";
            scanLine.style.display='block';
            stopBtn.style.display='inline-block';

            const startT = Date.now();
            function ani() {
                if(!player || player.paused) return;
                requestAnimationFrame(ani);
                const p = ((Date.now()-startT)%LOOP_MS)/LOOP_MS;
                scanLine.style.transform = `translate(-50%,-50%) rotate(${p*360}deg) translate(50%,0)`;
            }
            ani();
            
            player.onended = stopPlayback;
        }

        function stopPlayback() {
            if(player) player.pause();
            scanLine.style.display='none';
            stopBtn.style.display='none';
            status.textContent = "Ready.";
        }
        stopBtn.onclick = stopPlayback;

    </script>
</body>
</html>

```
